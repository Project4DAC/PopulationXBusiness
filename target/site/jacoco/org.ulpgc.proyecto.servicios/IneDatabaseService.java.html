<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IneDatabaseService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PopulationXBusiness</a> &gt; <a href="index.source.html" class="el_package">org.ulpgc.proyecto.servicios</a> &gt; <span class="el_source">IneDatabaseService.java</span></div><h1>IneDatabaseService.java</h1><pre class="source lang-java linenums">package org.ulpgc.proyecto.servicios;

import com.google.gson.Gson;
import com.zaxxer.hikari.HikariConfig;
import com.zaxxer.hikari.HikariDataSource;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.sql.*;
import java.util.*;
import java.util.concurrent.*;
import java.util.stream.Collectors;

public class IneDatabaseService implements AutoCloseable {
    private final IneApiClient ineClient;
    private final Gson gson;
    private final HikariDataSource dataSource;
<span class="nc" id="L19">    private final Logger logger = LoggerFactory.getLogger(IneDatabaseService.class);</span>
    private static final int BATCH_SIZE = 1000;
<span class="nc" id="L21">    private static final int CORE_POOL_SIZE = Runtime.getRuntime().availableProcessors();</span>

    // SQL Queries as constants
    private static final String INSERT_OPERACION_QUERY = &quot;INSERT OR REPLACE INTO operaciones (Id, Cod_IOE, nombre, Codigo, url_operacion) VALUES (?,?,?,?,?)&quot;;
    private static final String INSERT_TABLA_QUERY = &quot;INSERT OR IGNORE INTO tablas &quot; +
            &quot;(id, nombre, codigo, periodicidad, publicacion, periodo_ini, anyo_periodo_ini, fecha_ref_fin, ultima_modificacion) &quot; +
            &quot;VALUES (?,?,?,?,?,?,?,?,?)&quot;;
    private static final String INSERT_TABLA_OPERACIONES_QUERY = &quot;INSERT OR IGNORE INTO tabla_operaciones (tabla_id, operacion_id) VALUES (?, ?)&quot;;

<span class="nc" id="L30">    public IneDatabaseService() {</span>
<span class="nc" id="L31">        this.ineClient = new IneApiClient();</span>
<span class="nc" id="L32">        this.gson = new Gson();</span>
<span class="nc" id="L33">        this.dataSource = createConnectionPool();</span>
<span class="nc" id="L34">    }</span>

    private HikariDataSource createConnectionPool() {
<span class="nc" id="L37">        HikariConfig config = new HikariConfig();</span>
<span class="nc" id="L38">        config.setJdbcUrl(&quot;jdbc:sqlite:ine_data.db?journal_mode=WAL&amp;busy_timeout=30000&amp;cache=shared&amp;mode=serialized&quot;);</span>
<span class="nc" id="L39">        config.setMaximumPoolSize(CORE_POOL_SIZE);</span>
<span class="nc" id="L40">        config.setMinimumIdle(CORE_POOL_SIZE / 2);</span>
<span class="nc" id="L41">        config.setConnectionTimeout(30000);</span>
<span class="nc" id="L42">        config.setIdleTimeout(600000);</span>
<span class="nc" id="L43">        config.setMaxLifetime(1800000);</span>
<span class="nc" id="L44">        return new HikariDataSource(config);</span>
    }

    public void procesarYGuardarOperaciones() throws IOException, InterruptedException {
        try {
<span class="nc" id="L49">            String jsonOperaciones = ineClient.getOperacionesDisponibles(IneApiClient.IneLanguage.ES, new HashMap&lt;&gt;());</span>
<span class="nc" id="L50">            IneOperacionesResponse[] operaciones = validateAndParseOperaciones(jsonOperaciones);</span>

<span class="nc" id="L52">            try (Connection conn = dataSource.getConnection()) {</span>
<span class="nc" id="L53">                createOperacionesTable(conn);</span>
<span class="nc" id="L54">                saveOperacionesWithBatchProcessing(conn, operaciones);</span>
            }
<span class="nc" id="L56">        } catch (SQLException e) {</span>
<span class="nc" id="L57">            logger.error(&quot;Error processing and saving operations&quot;, e);</span>
<span class="nc" id="L58">            throw new RuntimeException(&quot;Failed to process and save operations&quot;, e);</span>
<span class="nc" id="L59">        }</span>
<span class="nc" id="L60">    }</span>

    private IneOperacionesResponse[] validateAndParseOperaciones(String jsonOperaciones) {
<span class="nc bnc" id="L63" title="All 4 branches missed.">        if (jsonOperaciones == null || jsonOperaciones.trim().isEmpty()) {</span>
<span class="nc" id="L64">            logger.warn(&quot;Received empty operations JSON&quot;);</span>
<span class="nc" id="L65">            return new IneOperacionesResponse[0];</span>
        }
<span class="nc" id="L67">        return gson.fromJson(jsonOperaciones, IneOperacionesResponse[].class);</span>
    }

    private void saveOperacionesWithBatchProcessing(Connection conn, IneOperacionesResponse[] operaciones) throws SQLException {
<span class="nc" id="L71">        conn.setAutoCommit(false);</span>
<span class="nc" id="L72">        try (PreparedStatement pstmt = conn.prepareStatement(INSERT_OPERACION_QUERY)) {</span>
<span class="nc" id="L73">            int newOperationsCount = 0;</span>

<span class="nc bnc" id="L75" title="All 2 branches missed.">            for (int i = 0; i &lt; operaciones.length; i++) {</span>
<span class="nc" id="L76">                IneOperacionesResponse op = operaciones[i];</span>
<span class="nc" id="L77">                prepareOperacionStatement(pstmt, op);</span>
<span class="nc" id="L78">                pstmt.addBatch();</span>
<span class="nc" id="L79">                newOperationsCount++;</span>

<span class="nc bnc" id="L81" title="All 4 branches missed.">                if ((i + 1) % BATCH_SIZE == 0 || i == operaciones.length - 1) {</span>
<span class="nc" id="L82">                    pstmt.executeBatch();</span>
                }
            }

<span class="nc" id="L86">            conn.commit();</span>
<span class="nc" id="L87">            logger.info(&quot;Operations added: {}&quot;, newOperationsCount);</span>
<span class="nc" id="L88">        } catch (SQLException e) {</span>
<span class="nc" id="L89">            conn.rollback();</span>
<span class="nc" id="L90">            throw e;</span>
<span class="nc" id="L91">        }</span>
<span class="nc" id="L92">    }</span>

    public void procesarYGuardarTablas() throws IOException, InterruptedException {
<span class="nc" id="L95">        ExecutorService executorService = Executors.newFixedThreadPool(CORE_POOL_SIZE);</span>

<span class="nc" id="L97">        try (Connection conn = dataSource.getConnection()) {</span>
<span class="nc" id="L98">            createTablasAndRelationTables(conn);</span>

<span class="nc" id="L100">            List&lt;Integer&gt; operationIds = obtenerIdsOperaciones(conn);</span>

<span class="nc" id="L102">            List&lt;CompletableFuture&lt;Void&gt;&gt; futures = operationIds.stream()</span>
<span class="nc" id="L103">                    .map(operacionId -&gt; CompletableFuture.runAsync(() -&gt; {</span>
                        try {
<span class="nc" id="L105">                            procesarTablaParaOperacion(operacionId);</span>
<span class="nc" id="L106">                        } catch (IOException | SQLException e) {</span>
<span class="nc" id="L107">                            logger.error(&quot;Error processing operation {}: {}&quot;, operacionId, e.getMessage(), e);</span>
<span class="nc" id="L108">                        }</span>
<span class="nc" id="L109">                    }, executorService))</span>
<span class="nc" id="L110">                    .collect(Collectors.toList());</span>

<span class="nc" id="L112">            CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();</span>
<span class="nc" id="L113">        } catch (SQLException e) {</span>
<span class="nc" id="L114">            logger.error(&quot;Error processing tables&quot;, e);</span>
        } finally {
<span class="nc" id="L116">            shutdownExecutorService(executorService);</span>
        }
<span class="nc" id="L118">    }</span>

    private void procesarTablaParaOperacion(Integer operacionId) throws IOException, SQLException {
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (operacionId == null) {</span>
<span class="nc" id="L122">            logger.warn(&quot;Skipping null operation ID&quot;);</span>
<span class="nc" id="L123">            return;</span>
        }

<span class="nc" id="L126">        try (Connection conn = dataSource.getConnection()) {</span>
<span class="nc" id="L127">            Map&lt;String, String&gt; params = new HashMap&lt;&gt;();</span>
<span class="nc" id="L128">            String tablesJson = ineClient.getTablasOperacion(</span>
                    IneApiClient.IneLanguage.ES,
<span class="nc" id="L130">                    operacionId.toString(),</span>
                    params
            );

<span class="nc" id="L134">            IneTablaResponse[] tablas = validateAndParseTablas(tablesJson);</span>
<span class="nc bnc" id="L135" title="All 4 branches missed.">            if (tablas == null || tablas.length == 0) {</span>
<span class="nc" id="L136">                logger.info(&quot;No tables found for operation {}&quot;, operacionId);</span>
<span class="nc" id="L137">                return;</span>
            }

<span class="nc" id="L140">            conn.setAutoCommit(false);</span>

<span class="nc" id="L142">            try (PreparedStatement pstmtTablas = conn.prepareStatement(INSERT_TABLA_QUERY);</span>
<span class="nc" id="L143">                 PreparedStatement pstmtRelations = conn.prepareStatement(INSERT_TABLA_OPERACIONES_QUERY)) {</span>

<span class="nc" id="L145">                int tablesProcessed = processBatchTablas(pstmtTablas, pstmtRelations, tablas, operacionId);</span>

<span class="nc" id="L147">                conn.commit();</span>
<span class="nc" id="L148">                logger.info(&quot;Operation {} - Tables processed: {}&quot;, operacionId, tablesProcessed);</span>
<span class="nc" id="L149">            } catch (SQLException e) {</span>
<span class="nc" id="L150">                conn.rollback();</span>
<span class="nc" id="L151">                throw e;</span>
<span class="nc" id="L152">            }</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">        } catch (InterruptedException e) {</span>
<span class="nc" id="L154">            Thread.currentThread().interrupt();</span>
<span class="nc" id="L155">            throw new RuntimeException(e);</span>
<span class="nc" id="L156">        }</span>
<span class="nc" id="L157">    }</span>

    private IneTablaResponse[] validateAndParseTablas(String tablesJson) {
<span class="nc bnc" id="L160" title="All 4 branches missed.">        if (tablesJson == null || tablesJson.trim().isEmpty()) {</span>
<span class="nc" id="L161">            logger.warn(&quot;Received empty tables JSON&quot;);</span>
<span class="nc" id="L162">            return new IneTablaResponse[0];</span>
        }
<span class="nc" id="L164">        return gson.fromJson(tablesJson, IneTablaResponse[].class);</span>
    }

    private int processBatchTablas(PreparedStatement pstmtTablas, PreparedStatement pstmtRelations,
                                   IneTablaResponse[] tablas, Integer operacionId) throws SQLException {
<span class="nc" id="L169">        int tablesProcessed = 0;</span>

<span class="nc bnc" id="L171" title="All 2 branches missed.">        for (IneTablaResponse tabla : tablas) {</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (tabla.getId() == null) continue;</span>

<span class="nc" id="L174">            prepareTablaStatement(pstmtTablas, tabla);</span>
<span class="nc" id="L175">            pstmtTablas.addBatch();</span>
<span class="nc" id="L176">            tablesProcessed++;</span>

<span class="nc" id="L178">            pstmtRelations.setInt(1, tabla.getId());</span>
<span class="nc" id="L179">            pstmtRelations.setInt(2, operacionId);</span>
<span class="nc" id="L180">            pstmtRelations.addBatch();</span>

<span class="nc bnc" id="L182" title="All 2 branches missed.">            if (tablesProcessed % BATCH_SIZE == 0) {</span>
<span class="nc" id="L183">                pstmtTablas.executeBatch();</span>
<span class="nc" id="L184">                pstmtRelations.executeBatch();</span>
            }
        }

<span class="nc" id="L188">        pstmtTablas.executeBatch();</span>
<span class="nc" id="L189">        pstmtRelations.executeBatch();</span>

<span class="nc" id="L191">        return tablesProcessed;</span>
    }

    private void createOperacionesTable(Connection conn) throws SQLException {
<span class="nc" id="L195">        try (Statement stmt = conn.createStatement()) {</span>
<span class="nc" id="L196">            stmt.execute(&quot;CREATE TABLE IF NOT EXISTS operaciones (&quot; +</span>
                    &quot;id INT PRIMARY KEY, &quot; +
                    &quot;COD_IOE TEXT,&quot; +
                    &quot;nombre TEXT, &quot; +
                    &quot;codigo TEXT,&quot; +
                    &quot;url_operacion TEXT)&quot;);
        }
<span class="nc" id="L203">    }</span>

    private void createTablasAndRelationTables(Connection conn) throws SQLException {
<span class="nc" id="L206">        try (Statement stmt = conn.createStatement()) {</span>
<span class="nc" id="L207">            stmt.execute(&quot;CREATE TABLE IF NOT EXISTS tablas (&quot; +</span>
                    &quot;id INTEGER PRIMARY KEY, &quot; +
                    &quot;nombre TEXT, &quot; +
                    &quot;codigo TEXT, &quot; +
                    &quot;periodicidad INTEGER, &quot; +
                    &quot;publicacion INTEGER, &quot; +
                    &quot;periodo_ini INTEGER, &quot; +
                    &quot;anyo_periodo_ini TEXT, &quot; +
                    &quot;fecha_ref_fin TEXT, &quot; +
                    &quot;ultima_modificacion BIGINT)&quot;);

<span class="nc" id="L218">            stmt.execute(&quot;CREATE TABLE IF NOT EXISTS tabla_operaciones (&quot; +</span>
                    &quot;tabla_id INTEGER, &quot; +
                    &quot;operacion_id INTEGER, &quot; +
                    &quot;PRIMARY KEY(tabla_id, operacion_id), &quot; +
                    &quot;FOREIGN KEY(tabla_id) REFERENCES tablas(id), &quot; +
                    &quot;FOREIGN KEY(operacion_id) REFERENCES operaciones(id))&quot;);

<span class="nc" id="L225">            stmt.execute(&quot;CREATE INDEX IF NOT EXISTS idx_tabla_operaciones &quot; +</span>
                    &quot;ON tabla_operaciones(tabla_id, operacion_id)&quot;);
        }
<span class="nc" id="L228">    }</span>

    private void prepareOperacionStatement(PreparedStatement pstmt, IneOperacionesResponse op) throws SQLException {
<span class="nc" id="L231">        pstmt.setInt(1, op.getId());</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">        pstmt.setString(2, op.getCod_IOE() != null ? op.getCod_IOE() : &quot;&quot;);</span>
<span class="nc bnc" id="L233" title="All 2 branches missed.">        pstmt.setString(3, op.getNombre() != null ? op.getNombre() : &quot;&quot;);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">        pstmt.setString(4, op.getCodigo() != null ? op.getCodigo() : &quot;&quot;);</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">        pstmt.setString(5, op.getUrl() != null ? op.getUrl() : &quot;&quot;);</span>
<span class="nc" id="L236">    }</span>

    private void prepareTablaStatement(PreparedStatement pstmt, IneTablaResponse tabla) throws SQLException {
<span class="nc" id="L239">        pstmt.setInt(1, tabla.getId());</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">        pstmt.setString(2, tabla.getNombre() != null ? tabla.getNombre() : &quot;&quot;);</span>
<span class="nc bnc" id="L241" title="All 2 branches missed.">        pstmt.setString(3, tabla.getCodigo() != null ? tabla.getCodigo() : &quot;&quot;);</span>

<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (tabla.getFK_Periodicidad() != null)</span>
<span class="nc" id="L244">            pstmt.setInt(4, tabla.getFK_Periodicidad());</span>
        else
<span class="nc" id="L246">            pstmt.setNull(4, Types.INTEGER);</span>

<span class="nc bnc" id="L248" title="All 2 branches missed.">        if (tabla.getFK_Publicacion() != null)</span>
<span class="nc" id="L249">            pstmt.setInt(5, tabla.getFK_Publicacion());</span>
        else
<span class="nc" id="L251">            pstmt.setNull(5, Types.INTEGER);</span>

<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (tabla.getFK_Periodo_ini() != null)</span>
<span class="nc" id="L254">            pstmt.setInt(6, tabla.getFK_Periodo_ini());</span>
        else
<span class="nc" id="L256">            pstmt.setNull(6, Types.INTEGER);</span>

<span class="nc" id="L258">        pstmt.setString(7, tabla.getAnyo_Periodo_ini());</span>
<span class="nc" id="L259">        pstmt.setString(8, tabla.getFechaRef_fin());</span>

<span class="nc bnc" id="L261" title="All 2 branches missed.">        if (tabla.getUltima_Modificacion() != null)</span>
<span class="nc" id="L262">            pstmt.setLong(9, tabla.getUltima_Modificacion());</span>
        else
<span class="nc" id="L264">            pstmt.setNull(9, Types.BIGINT);</span>
<span class="nc" id="L265">    }</span>

    private List&lt;Integer&gt; obtenerIdsOperaciones(Connection conn) throws SQLException {
<span class="nc" id="L268">        List&lt;Integer&gt; operationIds = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L270">        try (Statement stmt = conn.createStatement();</span>
<span class="nc" id="L271">             ResultSet rs = stmt.executeQuery(&quot;SELECT id FROM operaciones&quot;)) {</span>

<span class="nc bnc" id="L273" title="All 2 branches missed.">            while (rs.next()) {</span>
<span class="nc" id="L274">                operationIds.add(rs.getInt(&quot;id&quot;));</span>
            }
        }

<span class="nc" id="L278">        return operationIds;</span>
    }

    @Override
    public void close() {
<span class="nc bnc" id="L283" title="All 2 branches missed.">        if (dataSource != null) {</span>
            try {
<span class="nc" id="L285">                dataSource.close();</span>
<span class="nc" id="L286">                logger.info(&quot;HikariCP connection pool closed successfully&quot;);</span>
<span class="nc" id="L287">            } catch (Exception e) {</span>
<span class="nc" id="L288">                logger.error(&quot;Error closing HikariCP connection pool&quot;, e);</span>
<span class="nc" id="L289">            }</span>
        }
<span class="nc" id="L291">    }</span>

    private void shutdownExecutorService(ExecutorService executorService) {
        try {
<span class="nc" id="L295">            executorService.shutdown();</span>
<span class="nc bnc" id="L296" title="All 2 branches missed.">            if (!executorService.awaitTermination(60, TimeUnit.SECONDS)) {</span>
<span class="nc" id="L297">                executorService.shutdownNow();</span>
<span class="nc" id="L298">                logger.info(&quot;ExecutorService shutdown forced&quot;);</span>
            }
<span class="nc" id="L300">        } catch (InterruptedException e) {</span>
<span class="nc" id="L301">            executorService.shutdownNow();</span>
<span class="nc" id="L302">            Thread.currentThread().interrupt();</span>
<span class="nc" id="L303">        }</span>
<span class="nc" id="L304">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>